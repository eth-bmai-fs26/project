<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BMAI FS26 - Meeting Task Assigner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background-color: #f8f9fa; padding: 20px; }
      #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.9); display: none;
        flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
      }
      .avatar-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; }
      .employee-header { font-size: 0.75rem; text-align: center; min-width: 80px; }
      .checkmark { color: #198754; font-size: 1.5rem; font-weight: bold; }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem"></div>
      <p class="mt-3 fw-bold text-secondary">AI is thinking...</p>
    </div>

    <div class="container">
      <div class="card shadow-sm p-4 mx-auto" style="max-width: 900px; border-radius: 15px">
        <h5 class="text-center text-secondary border-bottom pb-3">
          BMAI FS26 - Project 1 - Meeting Minutes Processor
        </h5>

        <div class="mt-3">
          <label class="form-label fw-bold">Paste Meeting Transcript:</label>
          <textarea
            id="transcriptInput"
            class="form-control"
            rows="6"
            placeholder="Paste text here... e.g. 'Sarah, please optimize the database queries.'"
          ></textarea>
        </div>

        <button onclick="runAssignment()" class="btn btn-primary w-100 mt-3" id="assignBtn">
          ðŸš€ Extract & Assign Tasks
        </button>

        <div class="mt-4 table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light text-center">
              <tr>
                <th style="width: 35%; text-align: left;">Task Description</th>
          
                <th class="employee-header">
                  <img src="https://ui-avatars.com/api/?name=B&background=random" class="avatar-img"/>
                  <div class="mt-1">Backend</div>
                  <span class="badge bg-secondary rounded-pill">ID: 0</span>
                </th>
          
                <th class="employee-header">
                  <img src="https://ui-avatars.com/api/?name=Cs&background=random" class="avatar-img"/>
                  <div class="mt-1">Support</div>
                  <span class="badge bg-secondary rounded-pill">ID: 1</span>
                </th>
          
                <th class="employee-header">
                  <img src="https://ui-avatars.com/api/?name=Ds&background=random" class="avatar-img"/>
                  <div class="mt-1">Data Sci</div>
                  <span class="badge bg-secondary rounded-pill">ID: 2</span>
                </th>
          
                <th class="employee-header">
                  <img src="https://ui-avatars.com/api/?name=Hr&background=random" class="avatar-img"/>
                  <div class="mt-1">HR</div>
                  <span class="badge bg-secondary rounded-pill">ID: 3</span>
                </th>
          
                <th class="employee-header">
                  <img src="https://ui-avatars.com/api/?name=Mk&background=random" class="avatar-img"/>
                  <div class="mt-1">Marketing</div>
                  <span class="badge bg-secondary rounded-pill">ID: 4</span>
                </th>
              </tr>
            </thead>
            <tbody id="taskBody">
              <tr><td colspan="6" class="text-center text-muted py-4">Paste text above and click Extract.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // --- THE UNIVERSAL BRIDGE ---
      async function getAIResponse(transcriptText) {
        // SCENARIO 1: GOOGLE COLAB
        if (window.google && google.colab) {
            console.log("Environment: Colab");
            const result = await google.colab.kernel.invokeFunction(
                'notebook.ProcessMinutes', // Python Function Name
                [transcriptText], 
                {}
            );
            return result.data['application/json'];
        } 
        // SCENARIO 2: LOCAL FLASK SERVER
        else {
            console.log("Environment: Localhost");
            const response = await fetch("http://localhost:5001/api/assign_tasks", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ transcript: transcriptText }),
            });
            if (!response.ok) throw new Error("Backend Error");
            return await response.json();
        }
      }

      // --- UI LOGIC ---
      async function runAssignment() {
        const text = document.getElementById("transcriptInput").value.trim();
        if (!text) { alert("Please enter text first!"); return; }

        const overlay = document.getElementById("loadingOverlay");
        const taskBody = document.getElementById("taskBody");
        overlay.style.display = "flex";

        try {
          // CALL THE BRIDGE
          const assignments = await getAIResponse(text);

          // RENDER RESULTS
          taskBody.innerHTML = "";
          if (!assignments || assignments.length === 0) {
             taskBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No tasks found.</td></tr>';
             return;
          }

          assignments.forEach((item) => {
            const row = document.createElement("tr");
            let html = `<td class="fw-medium px-2">${item.task}</td>`;
            // Checkboxes for IDs 0-4
            for (let id = 0; id <= 4; id++) {
                const isMatch = item.owner_id === id;
                html += `<td class="text-center">${isMatch ? '<span class="checkmark">âœ“</span>' : ''}</td>`;
            }
            row.innerHTML = html;
            taskBody.appendChild(row);
          });

        } catch (error) {
          console.error(error);
          alert("Error: " + error.message);
        } finally {
          overlay.style.display = "none";
        }
      }
    </script>
  </body>
</html>