<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BMAI FS26 - Project 1 - Meeting Task Assigner</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 50px;
      }

      /* Modal Backdrop Styling */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .avatar-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 5px;
      }

      .employee-header {
        font-size: 0.75rem;
        text-align: center;
        min-width: 80px;
      }

      .checkmark {
        color: #198754;
        font-size: 1.2rem;
        font-weight: bold;
      }

      .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      ></div>
      <p class="mt-3 fw-bold text-secondary" id="loadingText">Processing...</p>
    </div>

    <div class="container">
      <div
        class="card shadow-sm p-4 mx-auto"
        style="max-width: 900px; border-radius: 15px"
      >
        <h5 class="text-center text-secondary border-bottom pb-2">
          BMAI FS26 - Project 1 - Meeting Minutes Processor
        </h5>

        <div class="mb-3">
          <label for="meetingSelect" class="form-label fw-bold"
            >Select Meeting ID (0-99):</label
          >
          <div class="input-group">
            <select
              id="meetingSelect"
              class="form-select"
              onchange="loadMeeting()"
            >
              <option value="" selected disabled>Choose a meeting...</option>
              <!-- Options populated by JS -->
            </select>
            <button
              class="btn btn-outline-secondary"
              type="button"
              onclick="loadMeeting()"
            >
              Load
            </button>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label small fw-bold">Meeting Transcript</label>
          <textarea
            id="minutes"
            class="form-control"
            rows="6"
            readonly
            placeholder="Select a meeting to view transcript..."
          ></textarea>
        </div>

        <button
          onclick="runAssignment()"
          class="btn btn-dark w-100 mt-3"
          id="assignBtn"
          disabled
        >
          Extract & Assign Tasks
        </button>

        <div class="mt-4 table-responsive table-container">
          <table class="table table-hover align-middle mb-0" id="taskTable">
            <thead class="table-light">
              <tr>
                <th style="width: 30%">Task Description</th>
                <!-- Employee Columns: IDs 0-4 -->
                <th class="employee-header" title="ID: 0">
                  <img
                    src="https://ui-avatars.com/api/?name=BD&background=random"
                    class="avatar-img"
                  /><br />Backend Dev<br /><small>(ID: 0)</small>
                </th>
                <th class="employee-header" title="ID: 1">
                  <img
                    src="https://ui-avatars.com/api/?name=CS&background=random"
                    class="avatar-img"
                  /><br />Customer support<br /><small>(ID: 1)</small>
                </th>
                <th class="employee-header" title="ID: 2">
                  <img
                    src="https://ui-avatars.com/api/?name=DS&background=random"
                    class="avatar-img"
                  /><br />Data scientist<br /><small>(ID: 2)</small>
                </th>
                <th class="employee-header" title="ID: 3">
                  <img
                    src="https://ui-avatars.com/api/?name=HR&background=random"
                    class="avatar-img"
                  /><br />HR Specialist<br /><small>(ID: 3)</small>
                </th>
                <th class="employee-header" title="ID: 4">
                  <img
                    src="https://ui-avatars.com/api/?name=MT&background=random"
                    class="avatar-img"
                  /><br />Marketing<br /><small>(ID: 4)</small>
                </th>
              </tr>
            </thead>
            <tbody id="taskBody">
              <tr>
                <td colspan="6" class="text-center text-muted small py-4">
                  Select a meeting and click 'Extract & Assign Tasks' to see
                  results.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // Employee IDs corresponding to columns (0 to 4)
      const employeeIds = [0, 1, 2, 3, 4];
      let currentMeetingId = null;

      // Populate Meeting Select on Load
      document.addEventListener("DOMContentLoaded", async () => {
        const select = document.getElementById("meetingSelect");
        // Generate options 0-99
        for (let i = 0; i < 100; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.text = `Meeting ${i}`;
          select.appendChild(opt);
        }
      });

      async function getMeetingMinutes(meetingId) {
        // Bridge to Python function: getMeetingMinutes(meeting_id)
        // Ensure meetingId is passed as integer
        const result = await google.colab.kernel.invokeFunction(
          "getMeetingMinutes",
          [parseInt(meetingId)],
          {},
        );
        return result.data["text/plain"];
      }

      async function assignTasks(meetingId) {
        // Bridge to Python function: assignTasks(meeting_id)
        const result = await google.colab.kernel.invokeFunction(
          "assignTasks",
          [parseInt(meetingId)],
          {},
        );
        let rawData = result.data["text/plain"];
        if (rawData.startsWith("'") && rawData.endsWith("'")) {
          rawData = rawData.slice(1, -1);
        }
        return JSON.parse(rawData);
      }

      async function loadMeeting() {
        const select = document.getElementById("meetingSelect");
        const meetingId = select.value;
        if (!meetingId) return;

        currentMeetingId = meetingId;
        const overlay = document.getElementById("loadingOverlay");
        const minutesArea = document.getElementById("minutes");
        const assignBtn = document.getElementById("assignBtn");
        const taskBody = document.getElementById("taskBody");

        overlay.style.display = "flex";
        document.getElementById("loadingText").innerText =
          "Loading transcript...";

        try {
          // Call Colab bridge instead of fetch
          const data = await getMeetingMinutes(meetingId);

          minutesArea.value = data.replace(/\\n/g, "\n");
          assignBtn.disabled = false;
          taskBody.innerHTML =
            '<tr><td colspan="6" class="text-center text-muted small py-4">Transcript loaded. Click Assign Tasks.</td></tr>';
        } catch (error) {
          console.error(error);
          alert("Error loading meeting: " + error.message);
        } finally {
          overlay.style.display = "none";
        }
      }

      async function runAssignment() {
        if (currentMeetingId === null) return;

        const overlay = document.getElementById("loadingOverlay");
        const taskBody = document.getElementById("taskBody");

        overlay.style.display = "flex";
        document.getElementById("loadingText").innerText = "Assigning tasks...";

        try {
          // Call Colab bridge instead of fetch
          const assignments = await assignTasks(currentMeetingId);

          // Clear Table
          taskBody.innerHTML = "";

          if (assignments.length === 0) {
            taskBody.innerHTML =
              '<tr><td colspan="6" class="text-center text-muted small py-4">No tasks found for this meeting.</td></tr>';
            return;
          }

          // Generate Rows
          assignments.forEach((item) => {
            const row = document.createElement("tr");

            // Task column
            let rowHtml = `<td class="small fw-medium">${item.task}</td>`;

            // Employee columns (check ID match)
            employeeIds.forEach((id) => {
              const isAssigned = item.owner_id === id;
              rowHtml += `<td class="text-center">${isAssigned ? '<span class="checkmark">âœ“</span>' : ""}</td>`;
            });

            row.innerHTML = rowHtml;
            taskBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error assigning tasks:", error);
          alert("Failed to assign tasks. Check console.");
        } finally {
          overlay.style.display = "none";
        }
      }
    </script>
  </body>
</html>
<script>
  document.dispatchEvent(new Event("DOMContentLoaded"));
</script>
